pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- jojo's bizarre adventures


function _init()
	players = {
		create_player(1, "josuke", 11, 10),  
		create_player(2, "dio", 15, 10),
		create_player(3, "jotaro", 100, 10)
	}
end

function _update()
	for p in all(players) do
		update_player(p)
		update_stand(p)
		behavior_player(p)
	end
end

function _draw()
	cls()
	for p in all(players) do
		draw_player(p)
		draw_stand(p)
	end
	draw_target(players[1])
	draw_target(players[2])
end

-->8
-- database

database = {
	jotaro = {spr = 0, name = "Jotaro Kujo", color = 2, atk = 'a', range = 'c'},
	dio = {spr = 2, name="DIO", color = 10, atk = 'a',  range = 'c'},
	josuke = {spr = 4, name="Josuke Higashikata", atk = 'a', color = 8, range = 'c'}
}
atk = {a  = 3}
range = {c  = 400}

-->8
-- player behavior

function create_player(id, db, x, y)
	return {
		id = id,
		x = x,
		y = y,
		state = 0,
		target = 0,
		stand = {
			x = x,
			y = y,
			flip = false,
			state = 0,
			target = 0
		},
		hp = 10,
		flip = false,
		offset = 0,
		tick = 1,
		db = database[db]
	}
end

function update_player(p)
	if p.offset <= -0.3 or p.offset >= 0 then
		p.tick *= -1
	end
	p.state = 0
	p.offset += (p.tick * 0.1)
	p.target = find_target(p)
end

function behavior_player(p)
	if p.id <= 1 then
		control_player(p)
	else
		ia_player(p)
	end
end

function control_player(p)	
	if btn(â¬‡ï¸, p.id - 1) then p.y += 1; p.state = 1; end
	if btn(âž¡ï¸, p.id - 1) then p.x += 1; p.flip = false; p.state = 1; end
	if btn(â¬†ï¸, p.id - 1) then p.y -= 1; p.state = 1; end
	if btn(â¬…ï¸, p.id - 1) then p.x -= 1; p.flip = true; p.state = 1; end
	if btn(ðŸ…¾ï¸, p.id - 1) then activate_stand(p) end
end

function ia_player(p)
	if p.target > 0 then
		activate_stand(p)
	end
end

function find_target(p)
	for other in all(players) do
		if p.id != other.id and compute_distance(p, other) <= range[p.db.range] then
			return other.id
		end
	end
	return 0
end

function move_to_point(p, point)
	if p.x > point.x then
		p.x -= 1
		p.flip = true
	end
	if p.x < point.x then
		p.x += 1
		p.flip = false
	end
	if p.y > point.y then
		p.y -= 1
	end
	if p.y < point.y then
		p.y += 1
	end
end

function compute_distance(p1, p2)
	local dx, dy = p1.x - p2.x, p1.y - p2.y
	return abs(dx * dx + dy * dy)
end



function activate_stand(p)
	if p.stand.state == 0 then
		p.stand.x = p.x
		p.stand.y = p.y
	end
	if p.target > 0 then
		p.stand.state = 1;
		p.stand.target = p.target;
	end
end

function callback_stand(p)
	p.stand.state = 2
	p.stand.target = p.id
end

function deactivate_stand(p)
	p.stand.state = 0
	p.stand.target = 0
end

function attack_player_stand(p, opponent)
	if p.stand.state == 0 then
		p.flip = not opponent.stand.flip
		p.x -= atk[opponent.db.atk]
		p.hp -= atk[opponent.db.atk]
	end
end

function update_stand(p)
	if p.stand.state > 0 then
		local distance = compute_distance(p.stand, players[p.stand.target])
		if distance == 0 then
			if p.stand.state == 1 then
				attack_player_stand(players[p.stand.target], p)
				callback_stand(p)
			else
				deactivate_stand(p)
			end
		else if distance > range[p.db.range] then
			callback_stand(p)
		else
			move_to_point(p.stand, players[p.stand.target])
		end
	end
end

-->8
-- player gfx

function draw_player(p)
	local x = 0
	if p.state == 1 then
		x = p.offset
	end
	rectfill(p.x + 1 + x, p.y + 8, p.x + 1 + x, p.y + 8, p.db.color)
	rectfill(p.x + 5 - x, p.y + 8, p.x + 5 - x, p.y + 8, p.db.color)
	spr(p.db.spr, p.x, p.y + p.offset, 1, 1, p.flip)
end

function draw_stand(p)
	if p.stand.state > 0 then
		spr(p.db.spr + 1, p.stand.x, p.stand.y + p.offset, 1, 1, p.stand.flip)
	end
end

function draw_target(p)
	if p.target > 0 then
		spr(255, players[p.target].x, players[p.target].y)
	end
end


__gfx__
011191000151510009a9aa0009aaaa00022121210dcccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111111099aaa000333bb0009999900021212110ddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000
01e0e0000120200009e8e8000990900002ebeb000dd0d00000000000000000000000000000000000000000000000000000000000000000000000000000000000
01ffff0002dccc0009ffff0004aaaa0002ffff0008eeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000
01ffff0002dc2c000effff0004aa9a000effff0008eede0000000000000000000000000000000000000000000000000000000000000000000000000000000000
011181009a88889009aa5a0009499400022a3a000cdc8c0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0111810001dccd0009aa5a000a9aa900011272000e8ee80000000000000000000000000000000000000000000000000000000000000000000000000000000000
0111210002dccd00033353000a4aa4000122210008d88d0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066d00d66
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000065000056
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d000000d
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d000000d
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000065000056
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066d00d66
